extends layout
block content
	.row.main-row
		.col.s3.vis-details.z-depth-1(style='padding-left: 0')
			.row
				.card
					.card-content.white-text
						span.card-title=lang.vis_titles[visname]
						p=lang.vis_details[visname]

			.row(style='padding-left: 10px;')
				button.btn(onclick='genPdfDoc()')=lang.generate_pdf
		//.col.s9.svg-container
		//	svg#svg-port.z-depth-1.svg-port
		.col.s9.svg-container
			#map(style='height: 100%; padding: 20px')
block append scripts
	script.
		var map;
		function initMap() {
			map = new google.maps.Map(document.getElementById('map'), {
				center: {lat: 52.23, lng: 20.92},
				zoom: 3
			});
		}
		var clustererStyles = [ {
			url: 'http://i.imgur.com/1Egeyzw.png',
			height: 53,
			width: 53,
			textSize: 10
		}, {
			url: 'http://i.imgur.com/eGZu1Qe.png',
			height: 70,
			width: 70,
			textSize: 11
		}, {
			url: 'http://i.imgur.com/Xnk702C.png',
			height: 100,
			width: 100,
			textSize: 12
		}, {
			url: 'http://i.imgur.com/XjQONEB.png',
			height: 130,
			width: 130,
			textSize: 30
		}, {
			url:'http://i.imgur.com/cpeTCOH.png',
			height: 180,
			width: 180,
			textSize: 50
		} ];
		//
		//    for(var i=0; i<20; i++) {
		//        var size = i * 5 + 30;
		//        clustererStyles.push({
		//            url: 'http://i.imgur.com/SlsBy7L.png',
		//            height: size,
		//            width: size,
		//            anchor: [16, 0],
		//            textSize: size / 3
		//        })
		//    }
		$(document).ready(function () {
			$.post("google-map", {}, function (data) {
				var maxSize = 200;
				var minSize = 20;
				var maxAmount = data.length;
				var calc = function(markers) {
					var size = (markers.length / maxAmount) * maxSize;
					if(size < minSize) size = minSize;
					return {width: size, height: size};
				}
				let markers = [];
				//            data.forEach(function (datum) {
				//                console.log(datum.potentialCity)
				//                //for(var prop in datum) if(datum.hasOwnProperty(prop)) console.log(prop);
				//            })
				var titles = {};
				data.forEach((workObject, index) => {
					if(typeof workObject.lat != 'number') return;
				titles[index] = workObject.title;
				var marker = new google.maps.Marker({
					position: new google.maps.LatLng(workObject.lat, workObject.lng),
					map: map,
					clickable: false,
					titleKey: index
				})
				markers.push(marker);
				markers[markers.length - 1].setClickable(false);
			});
				var markerCluster = new MarkerClusterer(map, markers, {
					averageCenter: true,
					zoomOnClick: false,
					minimumClusterSize: 1
				});
				//markerCluster.setCalculator(calc)
				google.maps.event.addListener(markerCluster, "click", function (c) {
					console.log('event fired');
					var clusteredTitles = '<div><b> Opublikowano tutaj: </b> <br/>'
					var m = c.getMarkers();
					for (var i = 0; i < m.length; i++ ) clusteredTitles = (clusteredTitles + (titles[m[i].titleKey] + '<br/>'))
					var infowindow = new google.maps.InfoWindow({
						content: clusteredTitles,
						position: c.getCenter()
					});
					infowindow.open(map);
				})
			});
		})
	script(src='/js/load-name.js')
	script(src='/js/markerclusterer.js')
	script(src='https://maps.googleapis.com/maps/api/js?key=AIzaSyDlLa8WDlJVmN_zmQ3zw4UrvPujezvkRAo&callback=initMap', async='', defer='')
