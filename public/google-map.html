<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="../../favicon.ico">
    <link type="text/css" rel="stylesheet" href="/css/materialize.min.css" media="screen,projection"/>
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="/font-awesome-4.6.3/css/font-awesome.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/css/example-styles.css">
    <link rel="stylesheet" href="/css/main.css">

    <title>Mapa publikacji</title>
</head>

<body>

<script src="https://d3js.org/d3-path.v1.min.js"></script>
<script src="/js/jquery-3.1.0.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="/js/remove-diacritics.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="/js/d3-tip.js"></script>
<script src="/js/parse-raw-expertus.js"></script>
<script src="/js/collab-demo-1.js"></script>
<script src="/js/bar-graph.js"></script>
<script src="/js/works-over-time-demo-1.js"></script>
<script src="/js/expertus-retriever.js"></script>
<script src="/js/collab.js"></script>

<div class="row top-nav z-depth-1">
    <div style="float: left; height: 50px">
        <ul>
            <li style="font-size: xx-large; margin-bottom: -8px; margin-top: -10px"><a href="/"> Wizualizator dorobku naukowego </a></li>
            <li style="font-size: medium">Scientific output visualizer</li>
        </ul>
    </div>

    <div style="float: right; height: 50px">
        <a href="index.html"><i class="fa fa-arrow-left back-arrow" aria-hidden="true"></i></a>
    </div>

    <div style="margin-left: auto; margin-right: auto;padding-top: 5px;  width: 300px; height:5em">
        <ul>
            <li style="margin-top: -15px;" id="query-name-caption">Wizualizacje dla:</li>
            <li><div id="query-name-container" class="name-display"></div></li>
        </ul>

    </div>
</div>

<div class="row main-row">
    <div class="col s3 vis-details z-depth-1" style="padding-left: 0">
        <div class="row">
            <div class="card">
                <div class="card-content white-text">
                    <span class="card-title">Mapa publikowania prac</span>
                    <p>Mapa ukazuje miejsca gdzie są wydawane prace autora. Wyświetlany obszar jest automatycznie skalowany do zakresu geograficznego występujących lokalizacji.</p>
                </div>
            </div>
        </div>

        <!--<div class="row">-->
        <!--<ul class="collection with-header z-depth-1">-->
        <!--<li class="collection-header"><h5>Szczegóły</h5></li>-->
        <!--<li class="collection-item"><div><span>Liczba współautorów: </span> <span id="coworkers-amount-display" style="float: right">-</span></div></li>-->
        <!--<li class="collection-item"><div><span>Najwięcej wspólnych prac z: </span> <span id="max-shared-works-amount-display" style="float: right">-</span></div></li>-->
        <!--<li class="collection-item"><div><span>Średnia liczba prac: </span> <span id="mean-coworkers-amount-display" style="float: right">-</span></div></li>-->
        <!--<li class="collection-item"><div><span>Łącznie prac: </span> <span id="works-amount-display" style="float: right">-</span></div></li>-->
        <!--</ul>-->
        <!--</div>-->

    </div>
    <div class="col s9  svg-container">
        <div id="map" style="height: 100%; padding: 20px"></div>


        <!--
                <svg class="z-depth-1 svg-port" id="svg-port"></svg>
        -->
    </div>
</div>




<script>
    var map;
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 52.23, lng: 20.92},
            zoom: 3
        });
    }

    var clustererStyles = [ {
        url: 'http://i.imgur.com/1Egeyzw.png',
        height: 53,
        width: 53,
        textSize: 10
    }, {
        url: 'http://i.imgur.com/eGZu1Qe.png',
        height: 70,
        width: 70,
            textSize: 11
    }, {
            url: 'http://i.imgur.com/Xnk702C.png',
        height: 100,
        width: 100,
            textSize: 12
    }, {
            url: 'http://i.imgur.com/XjQONEB.png',
        height: 130,
        width: 130,
            textSize: 30
    }, {
            url:'http://i.imgur.com/cpeTCOH.png',
        height: 180,
        width: 180,
            textSize: 50
        } ];
//
//    for(var i=0; i<20; i++) {
//        var size = i * 5 + 30;
//        clustererStyles.push({
//            url: 'http://i.imgur.com/SlsBy7L.png',
//            height: size,
//            width: size,
//            anchor: [16, 0],
//            textSize: size / 3
//        })
//    }

    $(document).ready(function () {
        $.post("google-map", {}, function (data) {

            var maxSize = 200;
            var minSize = 20;
            var maxAmount = data.length;
            var calc = function(markers) {
                var size = (markers.length / maxAmount) * maxSize;
                if(size < minSize) size = minSize;
                return {width: size, height: size};
            }

            let markers = [];
//            data.forEach(function (datum) {
//                console.log(datum.potentialCity)
//                //for(var prop in datum) if(datum.hasOwnProperty(prop)) console.log(prop);
//            })
            var titles = {};
            data.forEach((workObject, index) => {
                if(typeof workObject.lat != 'number') return;
                titles[index] = workObject.title;
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(workObject.lat, workObject.lng),
                    map: map,
                    clickable: false,
                    titleKey: index
                })
                markers.push(marker);
                markers[markers.length - 1].setClickable(false);


            });

            var markerCluster = new MarkerClusterer(map, markers, {
                averageCenter: true,
                zoomOnClick: false,
                minimumClusterSize: 1
            });
            //markerCluster.setCalculator(calc)

            google.maps.event.addListener(markerCluster, "click", function (c) {
                console.log('event fired');
                    var clusteredTitles = '<div><b> Opublikowano tutaj: </b> <br/>'
                    var m = c.getMarkers();
                    for (var i = 0; i < m.length; i++ ) clusteredTitles = (clusteredTitles + (titles[m[i].titleKey] + '<br/>'))

                    var infowindow = new google.maps.InfoWindow({
                        content: clusteredTitles,
                        position: c.getCenter()
                    });
                    infowindow.open(map);
                })



        });


    })
</script>
<script src="/js/load-name.js"></script>

<script src="/js/markerclusterer.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlLa8WDlJVmN_zmQ3zw4UrvPujezvkRAo&callback=initMap" async defer></script>

</body>
</html>